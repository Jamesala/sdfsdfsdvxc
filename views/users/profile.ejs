<!DOCTYPE html>
<html lang="pl">
<head>
  <title><%= member.username %> | Profil użytkownika Discord | Discordzik.pl</title>
  <meta http-equiv="content-type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Profil użytkownika <%= member.username %> na Discordzik.pl. Sprawdź biografię, posiadane boty i serwery Discord.">
  <meta name="keywords" content="<%= member.username %>, profil Discord, użytkownik Discord, <%= member.username %> Discord, społeczność Discord, discordzik.pl, polskie Discord">
  <meta name="theme-color" content="#5024f3">
  <meta name="robots" content="index, follow">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="<%= bot.users.cache.get(member.id)?.displayAvatarURL() || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" as="image">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  
  <!-- Favicon -->
  <link rel="shortcut icon" href="<%= bot.users.cache.get(member.id)?.displayAvatarURL() || 'https://cdn.discordapp.com/embed/avatars/0.png' %>">
  <link rel="apple-touch-icon" href="<%= bot.users.cache.get(member.id)?.displayAvatarURL() || 'https://cdn.discordapp.com/embed/avatars/0.png' %>">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://discordzik.pl/<%= member.id %>">
  <meta property="og:title" content="<%= member.username %> | Profil Discord">
  <meta property="og:description" content="<%= pdata ? (pdata?.biography || 'Profil użytkownika na Discordzik.pl') : 'Profil użytkownika na Discordzik.pl' %>">
  <meta property="og:image" content="<%= bot.users.cache.get(member.id)?.displayAvatarURL({ size: 1024 }) || 'https://cdn.discordapp.com/embed/avatars/0.png' %>">
  <meta property="og:image:width" content="1024">
  <meta property="og:image:height" content="1024">
  <meta property="og:image:alt" content="Awatar użytkownika <%= member.username %>">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://discordzik.pl/<%= member.id %>">
  <meta property="twitter:title" content="<%= member.username %> | Profil Discord">
  <meta property="twitter:description" content="<%= pdata ? (pdata?.biography || 'Profil użytkownika na Discordzik.pl') : 'Profil użytkownika na Discordzik.pl' %>">
  <meta property="twitter:image" content="<%= bot.users.cache.get(member.id)?.displayAvatarURL({ size: 1024 }) || 'https://cdn.discordapp.com/embed/avatars/0.png' %>">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://discordzik.pl/<%= member.id %>">

  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ProfilePage",
    "name": "<%= member.username %>",
    "description": "Profil użytkownika <%= member.username %> na Discordzik.pl",
    "url": "https://discordzik.pl/<%= member.id %>",
    "image": "<%= bot.users.cache.get(member.id)?.displayAvatarURL({ size: 1024 }) || 'https://cdn.discordapp.com/embed/avatars/0.png' %>",
    "mainEntity": {
      "@type": "Person",
      "name": "<%= member.username %>",
      "description": "<%= pdata ? (pdata?.biography || 'Użytkownik Discord') : 'Użytkownik Discord' %>"
    }
  }
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="./profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css">

  <!-- Preload fonts -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"></noscript>

  <!-- Inline critical CSS -->
  <style>
    body {
      font-family: 'Manrope', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      color: #212529;
    }
    .container {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
    .server-card, .bot-card {
      transition: transform 0.2s ease;
    }
    .server-card:hover, .bot-card:hover {
      transform: translateY(-5px);
    }
    .badge {
      font-weight: 500;
    }
    @media (max-width: 768px) {
      .container {
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
    }
  </style>
</head>

<%- include('../partials/head') %>

<body>
  <%- include('../partials/spinner') %>
  <main class="page-wrapper border-bottom">
    <%- include('../partials/header') %>

    <section class="container pt-5">
      <div class="row">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-4">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Strona główna</a></li>
            <li class="breadcrumb-item active" aria-current="page">Profil <%= member.username %></li>
          </ol>
        </nav>

        <!-- Sidebar (User info + Account menu) -->
        <%- include('partials/aside') %>

        <!-- Account details -->
        <div class="col-md-8 offset-lg-1 pb-5 mb-2 mb-lg-4 pt-md-2 mt-n3 mt-md-0">
          <div class="ps-md-3 ps-lg-0 mt-md-2 py-md-4">
            <h1 class="h2 pt-xl-1 pb-3">Profil użytkownika <%= member.username %></h1>
            
            <!-- Basic info -->
            <h2 class="h5 text-primary mb-4">Informacje podstawowe</h2>
            <form class="needs-validation border-bottom pb-3 pb-lg-4">
              <div class="row pb-2">
                <div class="col-12">
                  <% if (user && req.user.id == member.id) { %>
                  <label class="form-label fs-base" for="biography">Biografia <small class="text-muted">(opcjonalne)</small></label>
                  <textarea name="biography" id="biography" class="form-control form-control-lg" rows="4" placeholder="Napisz coś o sobie..."><%= pdata?.biography || '' %></textarea>
                  <% } else { %>
                  <% if (!pdata?.biography) { %>
                  <div class="alert d-flex alert-info" role="alert">
                    <i class="bx bx-info-circle lead me-3"></i>
                    <div>
                      Ten użytkownik nie dodał jeszcze biografii.
                    </div>
                  </div>
                  <% } else { %>
                  <label class="form-label fs-base">Biografia:</label> 
                  <div class="user-biography"><%= pdata?.biography %></div>
                  <% } %>
                  <% } %>
                </div>
              </div>
              <% if (user && req.user.id == member.id) { %>
              <div id="result" role="alert"></div>
              <div class="d-flex mb-3">
                <button id="editBio" class="btn btn-primary" aria-label="Zapisz zmiany w biografii">
                  <i class="bx bx-save me-2"></i>Zapisz zmiany
                </button>
              </div>
              <% } %>
            </form>

            <script>
              document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('editBio')?.addEventListener('click', function(e) {
                  e.preventDefault();
                  var bio = document.getElementById('biography')?.value || '';
                  var btn = this;
                  var originalText = btn.innerHTML;
                  
                  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span> Zapisywanie...';
                  btn.disabled = true;
                  
                  fetch('/profile/<%= member.id %>/edit/bio', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      biography: bio
                    })
                  }).then(res => res.json()).then(data => {
                    var resultDiv = document.getElementById("result");
                    if (data.error == false) {
                      btn.innerHTML = '<i class="bx bx-check me-2"></i>Zaktualizowano';
                      resultDiv.innerHTML = '<div class="alert alert-success" role="alert">' + data.message + '</div>';
                    } else {
                      btn.innerHTML = '<i class="bx bx-error me-2"></i>Błąd';
                      resultDiv.innerHTML = '<div class="alert alert-danger" role="alert">' + data.message + '</div>';
                    }
                    
                    setTimeout(function() {
                      btn.innerHTML = originalText;
                      btn.disabled = false;
                      if (data.error == false) {
                        location.reload();
                      }
                    }, 3000);
                  }).catch(error => {
                    console.error('Error:', error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    document.getElementById("result").innerHTML = '<div class="alert alert-danger" role="alert">Wystąpił błąd podczas zapisywania</div>';
                  });
                });
              });
            </script>

            <!-- Bots Section - TYLKO JEŚLI UŻYTKOWNIK MA BOTY -->
            <% if (bots.length > 0) { %>
            <h2 class="h5 text-primary pt-1 pt-lg-3 my-4">Boty Discord użytkownika</h2>
            <div class="accordion" id="userBotsAccordion">
              <% bots.forEach(a => { %>
                <div class="accordion-item border-0 rounded-3 shadow-sm mb-3">
                  <a href="/bot/<%= a.botID %>" class="text-decoration-none text-reset d-block p-3" aria-label="<%= a.username %> - <%= a.shortDesc %>">
                    <div class="d-flex align-items-center">
                      <img src="<%= bot.users.cache.get(a.botID)?.displayAvatarURL() || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" 
                           width="60" 
                           height="60"
                           class="rounded-circle me-3" 
                           alt="Awatar bota <%= a.username %>"
                           loading="lazy">
                      <div class="flex-grow-1">
                        <h3 class="h6 fw-semibold mb-1">
                          <%= a.username %>
                          <% if (a.promote === true) { %>
                          <span class="badge bg-warning text-dark ms-2">Promowany</span>
                          <% } %>
                        </h3>
                        <p class="small text-muted mb-2"><%= a.shortDesc %></p>
                        <div class="d-flex flex-wrap">
                          <span class="badge bg-info text-dark me-2 mb-1">
                            <i class="bx bx-like"></i> <%= a.votes.toLocaleString() %>
                          </span>
                          <% a.tags.slice(0, 3).forEach(t => { %>
                            <span class="badge bg-secondary me-2 mb-1"><%= t %></span>
                          <% }) %>
                          <% if (a.tags.length > 3) { %>
                            <span class="badge bg-secondary me-2 mb-1">
                              <i class="bx bx-plus"></i> <%= a.tags.length - 3 %> więcej
                            </span>
                          <% } %>
                        </div>
                      </div>
                      <i class="bx bx-chevron-right text-muted fs-4"></i>
                    </div>
                  </a>
                </div>
              <% }) %>
            </div>
            <% } %>

            <!-- Servers Section - TYLKO JEŚLI UŻYTKOWNIK MA SERWERY -->
            <% if (servers.length > 0) { %>
            <h2 class="h5 text-primary pt-1 pt-lg-3 my-4">Serwery Discord użytkownika</h2>
            <div class="accordion" id="userServersAccordion">
              <% servers.forEach(a => { %>
                <div class="accordion-item border-0 rounded-3 shadow-sm mb-3">
                  <a href="/server/<%= a.serverID %>" class="text-decoration-none text-reset d-block p-3" aria-label="<%= serverClient.guilds.cache.get(a.serverID)?.name || a.serverName %> - <%= a.shortDesc %>">
                    <div class="d-flex align-items-center">
                      <img src="<%= serverClient.guilds.cache.get(a.serverID)?.iconURL() || 'https://cdn.discordapp.com/embed/avatars/0.png' %>" 
                           width="60" 
                           height="60"
                           class="rounded-circle me-3" 
                           alt="Ikona serwera <%= serverClient.guilds.cache.get(a.serverID)?.name || a.serverName %>"
                           loading="lazy"
                           onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                      <div class="flex-grow-1">
                        <h3 class="h6 fw-semibold mb-1">
                          <%= serverClient.guilds.cache.get(a.serverID)?.name || a.serverName %>
                          <% if (a.status === 'PRO') { %>
                            <span class="badge bg-warning text-dark ms-2">PRO</span>
                          <% } else if (a.status === 'BASIC') { %>
                            <span class="badge bg-warning text-dark ms-2">BASIC</span>
                          <% } else if (a.status === 'GOLD') { %>
                            <span class="badge bg-warning text-dark ms-2">GOLD</span>
                          <% } %>
                        </h3>
                        <p class="small text-muted mb-2"><%= a.shortDesc %></p>
                        <div class="d-flex flex-wrap">
                          <span class="badge bg-info text-dark me-2 mb-1">
                            <i class="bx bx-like"></i> <%= a.votes.toLocaleString() %>
                          </span>
                          <span class="badge bg-dark me-2 mb-1">
                            <i class="bx bx-user"></i> <%= serverClient.guilds.cache.get(a.serverID)?.memberCount?.toLocaleString() || 'N/A' %>
                          </span>
                          <% a.tags.slice(0, 3).forEach(t => { %>
                            <span class="badge bg-secondary me-2 mb-1"><%= t %></span>
                          <% }) %>
                          <% if (a.tags.length > 3) { %>
                            <span class="badge bg-secondary me-2 mb-1">
                              <i class="bx bx-plus"></i> <%= a.tags.length - 3 %> więcej
                            </span>
                          <% } %>
                        </div>
                      </div>
                      <i class="bx bx-chevron-right text-muted fs-4"></i>
                    </div>
                  </a>
                </div>
              <% }) %>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="border-top border-light">
    <%- include('../partials/footer') %>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Track profile views
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'view_profile', {
          'user_id': '<%= member.id %>',
          'username': '<%= member.username %>'
        });
      }
    });
  </script>
</body>
</html>